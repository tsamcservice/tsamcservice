
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- 載入資料 -->
	<script src="../data/data.js"></script>
	<link rel="stylesheet" type="text/css" href="../data/styles.css">
	<!-- flex2html -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PamornT/flex2html@main/css/flex2html.css" />
	<script src="https://cdn.jsdelivr.net/gh/PamornT/flex2html@main/js/flex2html.min.js"></script>
	<!-- liff -->
	<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
	<!-- 提示框 -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.5/dist/sweetalert2.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.5/dist/sweetalert2.min.js"></script>
	<!-- dom-to-image -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
	<!-- fontawesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
	<script src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>
	<!-- pickr 調色盤 -->
	<link rel="stylesheet" type="text/css"
		href="https://cdn.jsdelivr.net/npm/@simonwep/pickr@latest/dist/themes/nano.min.css">
	<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr@latest/dist/pickr.min.js"></script>

</head>

<body>
	<div class="loader" id="loader">
		<div class="sk-chase">
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
		</div>
	</div>

	<script>
		var mainTitle_1, mainTitle_2, subTitle_1, subTitle_2, textContent_1, textContent_1_url, textContent_2, textContent_2_url, textContent_3, textContent_3_url, companyUnit, share_card, keep_card, cardDescription, bgColor, textColor;
		var flexJson, userId, readCount;

		function create_flex(data_card) {
			mainTitle_1 = data_card.mainTitle_1 || "磊山 人文講堂";
			mainTitle_2 = data_card.mainTitle_2 || "《牽風箏的人》";
			subTitle_1 = data_card.subTitle_1 || "余浩瑋";
			subTitle_2 = data_card.subTitle_2 || "青藝盟盟主";
			textContent_1 = data_card.textContent_1 || "05/06(六)09:50~12:00";
			textContent_1_url = data_card.textContent_1_url || "https://cardoa.saasou.com/_files/0/100/f/01_1_cafe.png";
			textContent_2 = data_card.textContent_2 || "磊山學院";
			textContent_2_url = data_card.textContent_2_url || "https://linecorp.com/";
			textContent_3 = data_card.textContent_3 || "台北市南京東路二段178號10樓";
			textColor = data_card.textColor || "#081F58FF";

			flexJson = {
				type: "flex",
				altText: "Flex Message",
				contents: {
					type: "carousel",
					contents: [
						{
							type: "bubble",
							hero: {
								type: "image",
								url: textContent_1_url,
								size: "full",
								aspectRatio: "1:1",
								aspectMode: "cover",
								action: {
									type: "uri",
									uri: textContent_2_url,
								},
							},
							body: {
								type: "box",
								layout: "vertical",
								position: "relative",
								height: "355px",
								contents: [
									{
										type: "box",
										layout: "vertical",
										backgroundColor: textColor,
										cornerRadius: "5px",
										contents: [
											{
												type: "text",
												text: "【" + mainTitle_1 + "】",
												weight: "bold",
												size: "xl",
												color: "#FFFFFFFF",
												align: "center",
												gravity: "center",
												contents: [],
											},
										],
									},
									{
										type: "box",
										layout: "horizontal",
										offsetTop: "5px",
										height: "45px",
										contents: [
											{
												type: "text",
												text: subTitle_1,
												weight: "bold",
												size: "xl",
												color: textColor,
												flex: 4,
												gravity: "center",
												contents: [],
											},
											{
												type: "text",
												text: subTitle_2,
												weight: "bold",
												color: textColor,
												flex: 8,
												gravity: "center",
												contents: [],
											},
										],
									},
									{
										type: "text",
										text: mainTitle_2,
										weight: "regular",
										color: textColor,
										contents: [],
									},
									{
										type: "text",
										text: "時間:" + textContent_1,
										weight: "regular",
										color: textColor,
										contents: [],
									},
									{
										type: "text",
										text: "地點:" + textContent_2,
										weight: "regular",
										color: textColor,
										contents: [],
									},
									{
										type: "text",
										text: "(" + textContent_3 + ")",
										weight: "regular",
										size: "sm",
										color: textColor,
										contents: [],
									},
									{
										type: "box",
										layout: "horizontal",
										position: "absolute",
										offsetTop: "200px",
										offsetStart: "10px",
										width: "10000px",
										contents: [
											{
												type: "box",
												layout: "vertical",
												paddingTop: "10px",
												width: "135px",
												height: "40px",
												backgroundColor: "#B5B8BDFF",
												contents: [
													{
														type: "text",
														text: "分享給好友",
														color: "#FFFFFFFF",
														align: "center",
														action: {
															type: "uri",
															uri: "https://liff.line.me/1660908511-Ol7grGPY/?userId=" + encodeURIComponent(userId),
														},
														contents: [],
													},
												],
											},
											{
												type: "box",
												layout: "vertical",
												offsetStart: "10px",
												paddingTop: "10px",
												width: "135px",
												height: "40px",
												backgroundColor: "#B5B8BDFF",
												contents: [
													{
														type: "text",
														text: "收藏資訊",
														color: "#FFFFFFFF",
														align: "center",
														contents: [],
													},
												],
											},
										],
									},
									{
										type: "box",
										layout: "vertical",
										action: {
											type: "uri",
											// "uri": "https://3428750.so-buy.com/"
											uri: "https://calendar.google.com/calendar/u/0/r/eventedit?pli=1&uid=62890calndrlink&sf=1&output=xml&dates=20230603T095000/20230603T120000&ctz=Asia/Taipei&text=【磊山+人文講堂】&details=【公益可以不一樣+成為改變的起點】",
										},
										position: "absolute",
										offsetTop: "250px",
										offsetStart: "10px",
										paddingTop: "10px",
										width: "280px",
										height: "40px",
										backgroundColor: "#91AFC2FF",
										contents: [
											{
												type: "text",
												text: "設定提醒(google行事曆)",
												color: "#FFFFFFFF",
												align: "center",
												contents: [],
											},
										],
									},
									{
										type: "box",
										layout: "vertical",
										action: {
											type: "uri",
											uri: "https://3428750.so-buy.com/",
										},
										position: "absolute",
										offsetTop: "300px",
										offsetStart: "10px",
										paddingTop: "10px",
										width: "280px",
										height: "40px",
										backgroundColor: "#91AFC2FF",
										contents: [
											{
												type: "text",
												text: "製作美美的卡片✨",
												color: "#FFFFFFFF",
												align: "center",
												contents: [],
											},
										],
									},
								],
							},
						},
					],
				},
			};
		}

		async function sendRequest(status, userId, dataCard = "", data = "") {
			if (!status || !userId) {
				alert("向google apps script寄送請求時\n有效參數不足");
				return;
			}

			const url = googleAppsScriptUrl;
			try {
				const sendData = { status: status, userId: userId, card: dataCard };

				// 將資料轉換成查詢字串
				const queryString = new URLSearchParams(sendData).toString();

				const response = await fetch(`${url}?${queryString}`);
				const responseData = await response.json();

				console.log("Data sent:", sendData);
				console.log("Response:", responseData);
				if (responseData.status === 'first') { return responseData; }
				else if (responseData.status === 'ok') { return responseData; }
				else { alert("向google apps script寄送請求時\n回傳值非ok"); }
			} catch (error) {
				alert("向google apps script寄送請求時\n發生錯誤\n" + error);
			}
		}

		window.onload = function () {
			document.getElementById('loader').style.display = 'flex';
			liff.init({ liffId: "1660908511-Ol7grGPY" }).then(() => {
				// 获取查询字符串
				var queryString = window.location.search;
				// 移除问号（?）
				queryString = queryString.slice(1);
				// 创建一个对象来存储参数和对应的值
				var parameters = {};
				// 遍历参数对，将其拆分为参数名和值，并存储到对象中
				queryString.split("&").forEach((pair) => {
					const [paramName, paramValue] = pair.split("=").map(decodeURIComponent);
					parameters[paramName] = paramValue;
				});
				if (!liff.isLoggedIn()) {
					document.cookie = "userId=" + parameters["userId"];
					liff.login();
				} else {
					userId = parameters["userId"] || document.cookie.split("; ").find((row) => row.startsWith("userId=")).split("=")[1];
					async function send() {
						var responseData = await sendRequest("get", userId);
						if (responseData.status === "ok") {
							const data_card = JSON.parse(responseData.card);
							create_flex(data_card);
							liff
								.shareTargetPicker([flexJson])
								.then(async function (res) {
									if (res) {
										// 向google sheet發送的增加閱讀數
										await sendRequest("addReadCount", userId);
										// 關閉 liff 視窗頁面 (手機)
										try { liff.closeWindow(); } catch (e) { }
										// 關閉 網頁 視窗頁面 (電腦)
										try { window.close(); } catch (e) { }
									} else {
										const [majorVer, minorVer] = (liff.getLineVersion() || "").split(".");
										if (parseInt(majorVer) < 10 || (parseInt(majorVer) == 10 && parseInt(minorVer) < 11)) {
											alert("沒有 TargetPicker 功能\n請嘗試更新 LINE");
										} else {
											alert("有 TargetPicker 功能，但發送訊息未成功");
										}
									}
								})
								.catch(function (error) {
									alert("分享傳送訊息失敗\n", err);
								});
						}
					}
					send();
				}
			});
		};
	</script>
</body>

</html>
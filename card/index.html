
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>LIFF Card Share</title>
	<!-- 載入資料 -->
	<script src="../data/data.js"></script>
	<link rel="stylesheet" type="text/css" href="../data/styles.css">
	<!-- flex2html -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PamornT/flex2html@main/css/flex2html.css" />
	<script src="https://cdn.jsdelivr.net/gh/PamornT/flex2html@main/js/flex2html.min.js"></script>
	<!-- liff -->
	<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
	<!-- 提示框 -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.5/dist/sweetalert2.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.5/dist/sweetalert2.min.js"></script>
	<!-- dom-to-image -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
	<!-- fontawesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
	<script src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>
	<!-- pickr 調色盤 -->
	<link rel="stylesheet" type="text/css"
		href="https://cdn.jsdelivr.net/npm/@simonwep/pickr@latest/dist/themes/nano.min.css">
	<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr@latest/dist/pickr.min.js"></script>

</head>

<body>
	<div class="loader" id="loader">
		<div class="sk-chase">
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
			<div class="sk-chase-dot"></div>
		</div>
	</div>

	<div class="loadPromotionalCard" id="loadPromotionalCard">
		<div class="form-container" style="max-width: 80%; width: auto; max-height: 90%;">
			<div style="display: flex; gap: 15px; align-items: center; ">
				<h2>選擇想要附加宣傳的卡片</h2>
				<button onclick="closePromotionalCard()">返回</button>
			</div>
			<div class="slider" id="slider" style="zoom: 0.7;">
				<!-- 這裡將會放入  promotional card 宣傳卡片 -->
			</div>
		</div>
	</div>

	<div class="hiddenForward">
		<div class="form-container">
			<div style="display: flex; justify-content: space-between; align-items: center; width: 310px">
				<h1 style="font-size:1.8em;">LIFF Card Share</h1>
				<button onclick="closeFlex()" style="height: 40px">返回</button>
			</div>
			<div style="display: flex; justify-content: space-between; width: 310px">
				<div class="links">
					<a title="Share by Line" onclick="shareButtonLine()">
						<i class="iconfont fab fa-line"></i>
					</a>
					<a title="Share by LinkedIn" id="shareButtonLinkedin" onclick="shareButtonLinkedin()" style="display: none">
						<i class="iconfont icon-linkedin"></i>
					</a>
					<a title="Share by FaceBook" target="_blank" rel="noopener" id="shareButtonFacebook"
						onclick="shareButtonFacebook(this)">
						<i class="iconfont icon-facebook"></i>
					</a>
					<a title="Share by Twitter" target="_blank" rel="noopener" id="shareButtonTwitter"
						onclick="shareButtonTwitter(this)">
						<i class="iconfont icon-twitter"></i>
					</a>
					<a title="Instagram" target="_blank" rel="noopener" href="https://www.instagram.com/wangzhengyan1219/"
						style="display: none">
						<i class="iconfont icon-instagram"></i>
					</a>
					<a title="Share by Mail" id="shareButtonMail" onclick="shareButtonMail(this)">
						<i class="iconfont far fa-envelope"></i>
					</a>
					<a title="Copy Link URL" onclick="shareButtonCopyURL()">
						<i class="iconfont fas fa-share"></i>
					</a>
					<a title="Download Card" onclick="downloadButton()">
						<i class="iconfont fas fa-save"></i>
					</a>
				</div>
			</div>
			<div class="downloadFlex">
				<div class="card">
					<div class="chatbox">
						<div id="flex2html_main"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="hiddenBackward">
		<div class="form-container">
			<div class="form-group">
				<div style="display: flex;justify-content: space-between; width: 310px ;">
					<button onclick="showFlex()">查看卡片</button>
					<button onclick="showPromotionalCard()">附加宣傳卡片</button>
				</div>
				<div class="form-group">
					<label>大圖 URL</label>
					<form>
						<label for="upload">
							<input type="button" id="uploadBtn" value="點我上傳" />
							<input type="file" id="upload" accept="image/*" />
						</label>
						<span id="upload_text"></span>
					</form>
				</div>
				<div class="form-group">
					<label>點擊大圖 URL</label>
					<input id="textContent_2_url" style="width: 100%" type="text" placeholder="https://linecorp.com/" />
				</div>
				<div class="form-group">
					<label>主標1</label>
					<input id="mainTitle_1" style="width: 100%" type="text" placeholder="磊山 人文講堂" />
				</div>
				<div class="form-group">
					<label>名稱</label>
					<input id="subTitle_1" style="width: 100%" type="text" placeholder="余浩瑋" />
				</div>
				<div class="form-group">
					<label>別名</label>
					<input id="subTitle_2" style="width: 100%" type="text" placeholder="青藝盟盟主" />
				</div>
				<div class="form-group">
					<label>主標2</label>
					<input id="mainTitle_2" style="width: 100%" type="text" placeholder="《牽風箏的人》" />
				</div>
				<div class="form-group">
					<label>時間</label>
					<input id="textContent_1" style="width: 100%" type="text" placeholder="05/06(六)09:50~12:00" />
				</div>
				<div class="form-group">
					<label>地點</label>
					<input id="textContent_2" style="width: 100%" type="text" placeholder="磊山學院" />
				</div>
				<div class="form-group">
					<label>地址</label>
					<input id="textContent_3" style="width: 100%" type="text" placeholder="台北市南京東路二段178號10樓" />
				</div>
				<div class="form-group">
					<label>文字顏色</label>
					<div style="display: flex;  align-items: center; width: 310px; gap: 10px;">
						<div id="colorPicker"></div>
						<span id="textColor">#081F58FF</span>
					</div>
				</div>
			</div>
		</div>

		<script>
			// 這張會員卡片的 URL
			var card_img_url;
			// 檢查 FB 跟 Twitter 按鈕是否有重複按下的旗標
			var buttonClickFlag = false;
			// 需要跨 function 的參數
			var flexJson, userId, flexJsonMessage, cardJsonPromotional

			function readShowCardData() {
				return JSON.stringify({
					mainTitle_1: document.getElementById("mainTitle_1").value || "",
					mainTitle_2: document.getElementById("mainTitle_2").value || "",
					subTitle_1: document.getElementById("subTitle_1").value || "",
					subTitle_2: document.getElementById("subTitle_2").value || "",
					textContent_1: document.getElementById("textContent_1").value || "",
					textContent_1_url: document.getElementById("upload_text").textContent || "",
					textContent_2: document.getElementById("textContent_2").value || "",
					textContent_2_url: document.getElementById("textContent_2_url").value || "",
					textContent_3: document.getElementById("textContent_3").value || "",
					textColor: document.getElementById("textColor").textContent || "",
					card_img_url: card_img_url,
				});
			}

			function writeShowCardData(data_card) {
				document.getElementById("mainTitle_1").value = data_card.mainTitle_1 || "";
				document.getElementById("mainTitle_2").value = data_card.mainTitle_2 || "";
				document.getElementById("subTitle_1").value = data_card.subTitle_1 || "";
				document.getElementById("subTitle_2").value = data_card.subTitle_2 || "";
				document.getElementById("textContent_1").value = data_card.textContent_1 || "";
				document.getElementById("upload_text").textContent = data_card.textContent_1_url || "";
				document.getElementById("textContent_2").value = data_card.textContent_2 || "";
				document.getElementById("textContent_2_url").value = data_card.textContent_2_url || "";
				document.getElementById("textContent_3").value = data_card.textContent_3 || "";
				// 設定textColor文字
				document.getElementById("textColor").textContent = data_card.textColor || "#081F58";
				// 設定colorPicker調色盤顏色
				colorPicker.setColor(data_card.textColor || "#081F58")
			}

			function closeFlex() {
				document.querySelector(".hiddenForward").classList.add("hidden");
				document.querySelector(".hiddenBackward").classList.remove("hidden");
			}
			function showFlex() {
				document.querySelector(".hiddenForward").classList.remove("hidden");
				document.querySelector(".hiddenBackward").classList.add("hidden");

				var mainTitle_1_Element = document.getElementById("mainTitle_1");
				var mainTitle_1 = mainTitle_1_Element.value || mainTitle_1_Element.placeholder;

				var mainTitle_2_Element = document.getElementById("mainTitle_2");
				var mainTitle_2 = mainTitle_2_Element.value || mainTitle_2_Element.placeholder;

				var subTitle_1_Element = document.getElementById("subTitle_1");
				var subTitle_1 = subTitle_1_Element.value || subTitle_1_Element.placeholder;

				var subTitle_2_Element = document.getElementById("subTitle_2");
				var subTitle_2 = subTitle_2_Element.value || subTitle_2_Element.placeholder;

				var textContent_1_Element = document.getElementById("textContent_1");
				var textContent_1 = textContent_1_Element.value || textContent_1_Element.placeholder;

				var textContent_1_url_Element = document.getElementById("upload_text");
				var textContent_1_url = textContent_1_url_Element.textContent || "https://i.ibb.co/B6KNp92/01-1-cafe.png";

				var textContent_2_Element = document.getElementById("textContent_2");
				var textContent_2 = textContent_2_Element.value || textContent_2_Element.placeholder;

				var textContent_2_url_Element = document.getElementById("textContent_2_url");
				var textContent_2_url = textContent_2_url_Element.value || textContent_2_url_Element.placeholder;

				var textContent_3_Element = document.getElementById("textContent_3");
				var textContent_3 = textContent_3_Element.value || textContent_3_Element.placeholder;

				var textColor_Element = document.getElementById("textColor");
				var textColor = textColor_Element.textContent;

				flexJson = [{
					type: "bubble",
					hero: {
						type: "image",
						url: textContent_1_url,
						size: "full",
						aspectRatio: "1:1",
						aspectMode: "cover",
						action: {
							type: "uri",
							uri: textContent_2_url,
						},
					},
					body: {
						type: "box",
						layout: "vertical",
						position: "relative",
						height: "355px",
						contents: [
							{
								type: "box",
								layout: "vertical",
								backgroundColor: textColor,
								cornerRadius: "5px",
								contents: [
									{
										type: "text",
										text: "【" + mainTitle_1 + "】",
										weight: "bold",
										size: "xl",
										color: "#FFFFFFFF",
										align: "center",
										gravity: "center",
										contents: [],
									},
								],
							},
							{
								type: "box",
								layout: "horizontal",
								offsetTop: "5px",
								height: "45px",
								contents: [
									{
										type: "text",
										text: subTitle_1,
										weight: "bold",
										size: "xl",
										color: textColor,
										flex: 4,
										gravity: "center",
										contents: [],
									},
									{
										type: "text",
										text: subTitle_2,
										weight: "bold",
										color: textColor,
										flex: 8,
										gravity: "center",
										contents: [],
									},
								],
							},
							{
								type: "text",
								text: mainTitle_2,
								weight: "regular",
								color: textColor,
								contents: [],
							},
							{
								type: "text",
								text: "時間:" + textContent_1,
								weight: "regular",
								color: textColor,
								contents: [],
							},
							{
								type: "text",
								text: "地點:" + textContent_2,
								weight: "regular",
								color: textColor,
								contents: [],
							},
							{
								type: "text",
								text: "(" + textContent_3 + ")",
								weight: "regular",
								size: "sm",
								color: textColor,
								contents: [],
							},
							{
								type: "box",
								layout: "horizontal",
								position: "absolute",
								offsetTop: "200px",
								offsetStart: "10px",
								width: "320px",
								contents: [
									{
										type: "box",
										layout: "vertical",
										paddingTop: "10px",
										width: "135px",
										height: "40px",
										backgroundColor: "#B5B8BD",
										contents: [
											{
												type: "text",
												text: "分享給好友",
												color: "#FFFFFFFF",
												align: "center",
												action: {
													type: "uri",
													uri: "https://liff.line.me/1660908511-Ol7grGPY/?userId=" + encodeURIComponent(userId),
												},
												contents: [],
											},
										],
									},
									{
										type: "box",
										layout: "vertical",
										offsetStart: "10px",
										paddingTop: "10px",
										width: "135px",
										height: "40px",
										backgroundColor: "#B5B8BD",
										contents: [
											{
												type: "text",
												text: "收藏資訊",
												color: "#FFFFFFFF",
												align: "center",
												contents: [],
											},
										],
									},
								],
							},
							{
								type: "box",
								layout: "vertical",
								action: {
									type: "uri",
									// "uri": "https://3428750.so-buy.com/"
									uri: "https://calendar.google.com/calendar/u/0/r/eventedit?pli=1&uid=62890calndrlink&sf=1&output=xml&dates=20230603T095000/20230603T120000&ctz=Asia/Taipei&text=【磊山+人文講堂】&details=【公益可以不一樣+成為改變的起點】",
								},
								position: "absolute",
								offsetTop: "250px",
								offsetStart: "10px",
								paddingTop: "10px",
								width: "280px",
								height: "40px",
								backgroundColor: "#91AFC2",
								contents: [
									{
										type: "text",
										text: "設定提醒(google行事曆)",
										color: "#FFFFFFFF",
										align: "center",
										contents: [],
									},
								],
							},
							{
								type: "box",
								layout: "vertical",
								action: {
									type: "uri",
									uri: "https://3428750.so-buy.com/",
								},
								position: "absolute",
								offsetTop: "300px",
								offsetStart: "10px",
								paddingTop: "10px",
								width: "280px",
								height: "40px",
								backgroundColor: "#91AFC2",
								contents: [
									{
										type: "text",
										text: "製作美美的卡片✨",
										color: "#FFFFFFFF",
										align: "center",
										contents: [],
									},
								],
							},
						],
					},
				}];

				// 找出已被選擇的宣傳卡片id
				var selectedElements = document.querySelectorAll(".card.promotionalCard.selected [id^='flex2htmlPromotional']");
				selectedElements.forEach(function (tempElement) {
					var selectedElementsIdNumer = parseInt(tempElement.id.replace("flex2htmlPromotional", ""));
					flexJson.push(JSON.parse(cardJsonPromotional[selectedElementsIdNumer]))
				});
				// 將flexJson繪出到HTML上
				my_flexToHtml("flex2html_main", flexJson);
			}

			function my_flexToHtml(flex2htmlElementName, flexJson) {
				flexJsonMessage = {
					type: "flex",
					altText: "Flex Message",
					contents: {
						type: "carousel",
						contents: [...flexJson]
					}
				}
				document.getElementById(flex2htmlElementName).innerHTML = "";
				flex2html(flex2htmlElementName, flexJsonMessage);

				// 将錯誤的 ExXxs 替換為正確的 ExXXs
				var wrongExXxsElements = document.querySelectorAll(".ExXxs");
				wrongExXxsElements.forEach(function (element) {
					element.classList.remove("ExXxs");
					element.classList.add("ExXXs");
				});

				// 将錯誤的 Ex3xl 替換為正確的 Ex3Xl
				var wrongEx3xlElements = document.querySelectorAll(".Ex3xl");
				wrongEx3xlElements.forEach(function (element) {
					element.classList.remove("Ex3xl");
					element.classList.add("Ex3Xl");
				});

				// 將 LySlider 關閉下方捲動軸
				var wrongLySliderElements = document.querySelectorAll(".LySlider");
				wrongLySliderElements.forEach(function (element) {
					element.style.webkitOverflowScrolling = "auto";
					// element.style.overflowX = "visible";
					element.style.overflow = "hidden";
				});

				// 將 chatbox 上方空白縮短
				var wrongChatboxElements = document.querySelectorAll(".chatbox");
				wrongChatboxElements.forEach(function (element) {
					element.style.paddingTop = "20px";
				});
			}

			async function sendRequest(status, userId, dataCard = "", data = "") {
				if (!status || !userId) {
					alert("向google apps script寄送請求時\n有效參數不足");
					return;
				}

				const url = googleAppsScriptUrl;
				try {
					const sendData = { status: status, userId: userId, card: dataCard };

					// 將資料轉換成查詢字串
					const queryString = new URLSearchParams(sendData).toString();

					const response = await fetch(`${url}?${queryString}`);
					const responseData = await response.json();

					console.log("Data sent:", sendData);
					console.log("Response:", responseData);
					if (responseData.status === 'first') { return responseData; }
					else if (responseData.status === 'ok') { return responseData; }
					else { alert("向google apps script寄送請求時\n回傳值非ok"); }
				} catch (error) {
					alert("向google apps script寄送請求時\n發生錯誤\n" + error);
				}
			}

			// colorPicker創建調色盤元素(文字放textColor)
			var textColor_Element = document.getElementById("textColor");
			const colorPicker = Pickr.create({
				el: '#colorPicker',
				theme: 'nano', // 使用 NANO 主題
				default: "#081F58", // 預設顏色
				components: {
					preview: true,
					opacity: true,
					hue: true,
					interaction: {
						input: true,
					}
				}
			});
			// colorPicker顏色更改事件
			colorPicker.on('change', (color) => {
				textColor_Element.textContent = color.toHEXA().toString();
			});
			// colorPicker失去焦點事件
			colorPicker.on('hide', () => {
				colorPicker.applyColor(); // 應用顏色到目標元素
				// 卡片資料存到google sheet
				sendRequest("save", userId, readShowCardData());
			});

			window.onload = function () {
				document.querySelector(".hiddenForward").classList.add("hidden");
				document.getElementById('loader').style.display = 'flex';
				liff.init({ liffId: "1660908511-DERZWN3m" })
					.then(() => {
						if (!liff.isLoggedIn()) {
							liff.login();
						}
						else {
							liff.getProfile()
								.then(async function (profile) {
									userId = profile.userId
									var responseData = await sendRequest("get", userId)
									if (responseData.status != "first") {
										const dataCard = JSON.parse(responseData.card);
										writeShowCardData(dataCard)
									}

									cardJsonPromotional = responseData.cardJsonPromotional
									for (var i = 0; i < cardJsonPromotional.length; i++) {
										var tempHtml = `
												<div class="card promotionalCard" onclick="selectPromotionalCard(this)">
													<div class="chatbox" style="pointer-events: none;">
														<div id="flex2htmlPromotional${i}"></div>
													</div>
												</div>`;

										// 把卡片元素 html 加寫入到 slider
										document.getElementById("slider").innerHTML += tempHtml;
										my_flexToHtml("flex2htmlPromotional" + i, [JSON.parse(cardJsonPromotional[i])])
									}
									document.getElementById('loader').style.display = 'none';
								})
								.catch(function (error) {
									alert("取得使用者資料錯誤\n" + error);
								});
						}
					});
			};

			// 分享line按钮的點擊事件
			function shareButtonLine() {
				liff
					.shareTargetPicker([flexJsonMessage])
					.then(async function (res) {
						if (res) {
							// 向google sheet發送的增加閱讀數
							await sendRequest("addReadCount", userId);
							// 送出提醒框
							Swal.fire({
								text: "卡片已送出",
								timer: 800,
								showConfirmButton: false
							});
						} else {
							const [majorVer, minorVer] = (liff.getLineVersion() || "").split(".");
							if (parseInt(majorVer) < 10 || (parseInt(majorVer) == 10 && parseInt(minorVer) < 11)) {
								alert("沒有 TargetPicker 功能\n請嘗試更新 LINE");
							} else {
								alert("有 TargetPicker 功能，但發送訊息未成功");
							}
						}
					})
					.catch(function (err) {
						alert("分享傳送訊息失敗\n請檢查URL及內容\n" + err);
					});
			}

			// 分享mail按钮的點擊事件
			function shareButtonMail(element) {
				element.href = "mailto:?subject=【卡片分享】&body=使用瀏覽器預覽照片連結：https://tsamcservice.github.io/preview/?userId=" + encodeURIComponent(userId);
				// document.getElementById("shareButtonMail").href = "mailto:?subject=【卡片分享】-&body=請參考圖片附件:[圖片](https://i.ibb.co/8YTW70m/blob.jpg)&attachment=https://i.ibb.co/8YTW70m/blob.jpg";
			}
			// 分享twitter按钮的點擊事件
			function shareButtonTwitter(element) {
				// 檢查是否有重複按(由於必須click()觸發，將會導致重複)
				if (!buttonClickFlag) {
					buttonClickFlag = true;
					// 截圖卡片後資料存入google sheet
					document.getElementById("loader").style.display = "flex";
					var card = document.querySelector(".downloadFlex");
					domtoimage.toBlob(card).then(async function (blob) {
						card_img_url = await uploadImg(blob)
						await sendRequest("save", userId, readShowCardData());
						var responseData = await sendRequest("uploadGithub", userId, readShowCardData());
						var shareOG_url = "https://twitter.com/intent/tweet?url=" + responseData.uploadOG_url;
						element.href = shareOG_url;
						element.click();
					})
						.catch(function (err) {
							alert("分享傳送訊息失敗\n" + err);
						});
				}
				else {
					buttonClickFlag = false;
					// 三秒後重整頁面
					setTimeout(function () { location.reload(); }, 3000);
				}
			}
			// 分享facebook按钮的點擊事件
			function shareButtonFacebook(element) {
				// 截圖卡片後資料存入google sheet
				document.getElementById("loader").style.display = "flex";
				var card = document.querySelector(".downloadFlex");
				domtoimage.toBlob(card).then(async function (blob) {
					card_img_url = await uploadImg(blob)
					await sendRequest("save", userId, readShowCardData());
					var responseData = await sendRequest("uploadGithub", userId, readShowCardData());
					var shareOG_url = "https://www.facebook.com/sharer.php?u=" + responseData.uploadOG_url;
					alert(shareOG_url)
					// 跳轉
					liff.openWindow({
						url: shareOG_url,
						external: true  // 開啟外部瀏覽器
					});
					alert("若無跳轉請確認是否有阻擋彈跳視窗\n或自行複製分享網址："+shareOG_url)
				})
					.catch(function (err) {
						alert("分享傳送訊息失敗\n" + err);
					});
			}

			// 分享Copy Link URL按钮的點擊事件
			async function shareButtonCopyURL() {
				// 取得要複製的文字
				var textToCopy = "https://tsamcservice.github.io/preview/?userId=" + encodeURIComponent(userId)

				try {
					await navigator.clipboard.writeText(textToCopy);
				} catch (err) {
					try {
						// 建立一個臨時的 tempElement 元素
						var tempElement = document.createElement("textarea");
						tempElement.value = textToCopy;

						// 將 textarea 加入到文件中
						document.body.appendChild(tempElement);

						// 選取並複製文字
						tempElement.select();
						document.execCommand("copy");

						// 移除臨時的 textarea 元素
						tempElement.remove();
					} catch (err) {
						alert("無法複製文字")
						return;
					}
				}

				// 送出提醒框
				Swal.fire({
					text: "文字已複製到剪貼簿",
					timer: 800,
					showConfirmButton: false
				});
			}

			// 截圖按钮的點擊事件
			function downloadButton() {
				// 獲取瀏覽器的使用者代理
				var userAgent = navigator.userAgent;
				// 檢查是否執行於line
				var isOnLine = /line/i.test(userAgent)

				if (isOnLine) {
					// 由於line本身無法下載檔案，一律跳轉用外部瀏覽器下載
					alert("將自動開啟預設瀏覽器\n並下載檔案")
					liff.openWindow({
						url: 'https://tsamcservice.github.io/download_card/?userId=' + encodeURIComponent(userId),
						external: true  // 開啟外部瀏覽器
					});
				}
				else {
					// 取得下載框的元素
					var card = document.querySelector(".downloadFlex");

					// 使用dom-to-image庫進行截圖
					domtoimage.toBlob(card).then(function (blob) {
						// 創建下載連結
						var link = document.createElement("a");
						link.href = URL.createObjectURL(blob);
						// 獲取當前時間戳
						var timestamp = Date.now();

						var mainTitle_1_Element = document.getElementById("mainTitle_1");
						var mainTitle_1 = mainTitle_1_Element.value || mainTitle_1_Element.placeholder;
						link.download = mainTitle_1 + "_" + timestamp + ".png";

						// 觸發下載
						link.click();

						// 清理URL對象，釋放資源
						URL.revokeObjectURL(link.href);
					})
						.catch(function (error) {
							alert("下載錯誤\n" + error);
						});
				}
			}

			// 跳出 promotional card 視窗彈跳
			function showPromotionalCard() {
				document.getElementById("loadPromotionalCard").style.display = "flex";
			}
			// RENAME：處理宣傳卡片事件
			function closePromotionalCard() {
				document.getElementById("loadPromotionalCard").style.display = "none";
			}
			// RENAME：處理宣傳卡片事件
			function selectPromotionalCard(element) {
				element.classList.toggle("selected");
			}

			// 檢查是否有新圖片更新到網頁並上傳
			document.getElementById("upload").addEventListener("change", async function (event) {
				document.getElementById("loader").style.display = "flex";
				var file = event.target.files[0]; // 取得選擇的檔案
				document.getElementById("upload_text").textContent = await uploadImg(file); // 上傳檔案並回傳URL
				sendRequest("save", userId, readShowCardData());
				document.getElementById("loader").style.display = "none";
			});

			// 上傳檔案並回傳URL
			function uploadImg(file) {
				return new Promise((resolve, reject) => {
					var reader = new FileReader();
					reader.onload = function () {
						var fileBlob = dataURLtoBlob(reader.result);
						var formData = new FormData();
						formData.append("image", fileBlob);

						fetch("https://api.imgbb.com/1/upload?key=9370c80a93b313d5f526531503162623&expiration=15552000", {
							method: "POST",
							body: formData,
						})
							.then(function (response) {
								return response.json();
							})
							.then(function (data) {
								resolve(data.data.display_url);
							})
							.catch(function (error) {
								alert("上傳照片錯誤\n" + error);
								reject(error);
							});
					};
					reader.readAsDataURL(file);
				});
			}
			function dataURLtoBlob(dataURL) {
				var arr = dataURL.split(","); // 將資料URL分割成類型和資料部分
				var mime = arr[0].match(/:(.*?);/)[1]; // 提取資料URL中的MIME類型
				var bstr = atob(arr[1]); // 解碼Base64編碼的資料部分
				var n = bstr.length;
				var u8arr = new Uint8Array(n);
				while (n--) {
					u8arr[n] = bstr.charCodeAt(n); // 轉換為Uint8Array
				}
				return new Blob([u8arr], { type: mime }); // 創建Blob物件
			}

			// 元素失去焦點事件
			document.addEventListener("blur", function (event) {
				// 檢查事件源是否為輸入框且已經loading完成
				if (event.target.tagName.toLowerCase() === "input" && document.getElementById("loader").style.display == "none") {
					// 檢查textContent_2_url的input格是否合法的url
					if (event.target.id === "textContent_2_url" && event.target.value != "") {
						try {
							new URL(event.target.value);
						} catch (error) {
							alert("URL格式錯誤")
							event.target.value = ""
							return;
						}
					}
					// 卡片資料存到google sheet
					sendRequest("save", userId, readShowCardData());
				}
			}, true); // 注意，這裡的 true 參數是為了在捕獲階段觸發事件，這對於 'blur' 和 'focus' 事件是必要的。


			// 拖曳滑動
			var slider = document.getElementById("slider");
			var isDown = false;
			var startX;
			var scrollLeft;

			slider.addEventListener("mousedown", function (e) {
				isDown = true;
				startX = e.pageX - slider.offsetLeft;
				scrollLeft = slider.scrollLeft;
			});
			slider.addEventListener("mouseleave", function () {
				isDown = false;
			});
			slider.addEventListener("mouseup", function () {
				isDown = false;
			});
			slider.addEventListener("mousemove", function (e) {
				if (!isDown) return;
				e.preventDefault();
				var x = e.pageX - slider.offsetLeft;
				var walk = x - startX;
				slider.scrollLeft = scrollLeft - walk;
			});
		</script>
</body>

</html>